---
title: "Analysing the DNA methylation data from paired GBM samples"
output: html_notebook
---

```{r setup}
require("knitr")
opts_knit$set(root.dir = normalizePath('..'))
```


```{r, message=FALSE, warning=FALSE, results="hide"}
source('io/output.R')
source('_settings.R')
source("utils.R")
library("ChAMP")
library("minfi")
library("wateRmelon")
```

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

We'll be using the `ChAMP` package to extract methylation beta values from the Illumina raw data files (`*.idat`).

Start by defining the input directory. This must contain a single `.csv` file in the standard Illumina sample sheet format. Data from different chips are located in subdirectories with the name of the chip. *All* of the samples listed will be loaded. We don't want all of them, so we will run the first few steps manually. 

Load data, filtering by beadcount to keep only the relevant probes (this can't be done downstream as it relies on the raw red/green data and we only use beta/M values beyond this point). For beadcount filtering, the `ChAMP` implementation removes those probes for which >5% of records have a beadcount of <3. In our small sample case, this is the same as requiring that *no single sample* has <3 beads.

```{r}
base.dir <- file.path(data.dir.raid, 'methylation', '2016-12-19_ucl_genomics')
in.dir <- file.path(base.dir, 'idat')

# Carry out filtering on the targets sheet before loading data
targets <- read.metharray.sheet(in.dir)
targets <- targets[!grepl('icb', targets$Sample_Name, ignore.case = T),]
targets <- targets[grepl('018|019|031', targets$Sample_Name),]
targets$Sample_Name <- c(
  "GBM018",
  "GBM019",
  "GBM031",
  "Dura018",
  "Dura019",
  "Dura031"
)
targets$Sample_Group <- c(
  rep("GBM", 3), rep("iNSC", 3)
)

rgSet <- read.metharray.exp(targets = targets, extended=TRUE)
# rgSet@annotation <- c(array="IlluminaHumanMethylationEPIC",annotation="ilmn10.hg19")
rgSet@annotation <- c(array="IlluminaHumanMethylationEPIC",annotation="ilm10b2.hg19")

bc <- beadcount(rgSet)
keep.idx <- which(as.vector(rowSums(is.na(bc)) == 0))
bc <- na.omit(bc)

mset <- preprocessRaw(rgSet)
mset <- mset[rownames(bc),]

detP <- detectionP(rgSet)
detP <- detP[rownames(bc),]

pd <- pData(rgSet)

beta.raw <- getBeta(mset, "Illumina")
colnames(beta.raw) <- pd[colnames(beta.raw), 'Sample_Name']
```

Now we filter the data using the default ChAMP process. This has a few steps:
 - Remove any samples with too many failed probes
 - Remove probes with a poor detection probability
 - Remove some probes that other research has shown to be poor
 - Remove X, Y chromosome probes.

```{r}
myLoad <- champ.filter(beta.raw, detP = detP, pd = pd, arraytype = "EPIC")
```

Now we have loaded the data, we should normalise it. There are several options: BMIQ, SWAN, PBC and FunctionalNormalize. The latter is *not* supported for EPIC arrays.

```{r}
beta.bmiq <- champ.norm(beta = myLoad$beta, method = 'BMIQ', arraytype = "EPIC", cores=4)
```

```{r}
beta.pbc <- champ.norm(beta = myLoad$beta, method = 'PBC', arraytype = "EPIC")
```

```{r}
mset.swan <- preprocessSWAN(rgSet, mSet = mset)
beta.swan <- getBeta(mset.swan)
beta.swan <- beta.swan[rownames(myLoad$beta),]
colnames(beta.swan) <- pd[colnames(beta.swan), 'Sample_Name']
```

```{r}
grSet.funnorm <- preprocessFunnorm(rgSet)
beta.funnorm <- getBeta(grSet.funnorm)[rownames(myLoad$beta),]
```

Since that process is fairly time-consuming, we'll save the beta values to CSV.

```{r, message=FALSE, warning=FALSE}
outDir <- file.path(base.dir, 'beta')
dir.create(outDir, showWarnings = FALSE)
write.csv(beta.raw, file = file.path(outDir, "beta_raw.csv"))
write.csv(beta.bmiq, file = file.path(outDir, "beta_bmiq.csv"))
write.csv(beta.swan, file = file.path(outDir, "beta_swan.csv"))
write.csv(beta.pbc, file = file.path(outDir, "beta_pbc.csv"))
write.csv(beta.funnorm, file = file.path(outDir, "beta_funnorm.csv"))
```

Now we load annotations for the probes. In particular, we want the chromosome and chromosomal coordinate, but we also get any associated genes and a very approximate categorical distance from the TSS.

*NB: Illumina released an updated version of the manifest (b3) on 17th Apr 2017, but this hasn't been supplied in Bioconductor yet. Keep an eye out for it!*

```{r}
library(IlluminaHumanMethylationEPICanno.ilm10b2.hg19)
head(IlluminaHumanMethylationEPICanno.ilm10b2.hg19::Locations)
head(IlluminaHumanMethylationEPICanno.ilm10b2.hg19::Other)
```




Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
